@using MudBlazor
@using Microsoft.Extensions.Logging
@using Microsoft.Extensions.Logging.Abstractions
@using Mythetech.Framework.Infrastructure.Plugins.Components
@using Mythetech.Plugins.Agent.Models
@using Mythetech.Plugins.Agent.Services
@inherits PluginContextPanel
@attribute [PluginComponentMetadata(
    Icon = Icons.Material.Outlined.SmartToy,
    Title = "Claude Agent",
    Order = 5)]

@if (!_isCliInstalled.HasValue)
{
    <div class="d-flex justify-center align-center" style="height: 100%;">
        <MudProgressCircular Indeterminate="true" />
    </div>
}
else if (!_isCliInstalled.Value)
{
    <CliNotInstalledView Instructions="@_installInstructions"
                         OnRetryCheck="CheckCliInstallation" />
}
else
{
    <div class="agent-panel d-flex flex-column" style="height: 100%;">
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="ma-2" ShowCloseIcon="true" CloseIconClicked="() => _errorMessage = null">
                @_errorMessage
            </MudAlert>
        }

        <div class="flex-grow-1" style="overflow: hidden;">
            <ChatView Messages="@_currentConversation.Messages"
                     IsStreaming="@_isStreaming"
                     StreamingContent="@_streamingContent" />
        </div>

        <div class="pa-3" style="border-top: 1px solid var(--mud-palette-divider);">
            <ChatInput OnSend="SendMessage"
                      IsDisabled="@_isStreaming"
                      OnCancel="CancelRequest" />
        </div>
    </div>
}

@code {
    public override string Icon { get; } = Icons.Material.Outlined.SmartToy;
    public override string Title { get; } = "Claude Agent";

    private bool? _isCliInstalled;
    private string _installInstructions = string.Empty;
    private Conversation _currentConversation = new();
    private bool _isStreaming;
    private string _streamingContent = string.Empty;
    private string? _errorMessage;

    private IClaudeCliDetector? _cliDetector;
    private IClaudeCliService? _cliService;
    private ILogger<AgentPanel>? _logger;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // Create services - in a real app these would be injected via DI
        _cliDetector = new ClaudeCliDetector();
        _logger = NullLogger<AgentPanel>.Instance;
        _cliService = new ClaudeCliService(_cliDetector, NullLogger<ClaudeCliService>.Instance);

        await CheckCliInstallation();
    }

    private async Task CheckCliInstallation()
    {
        _isCliInstalled = null;
        StateHasChanged();

        if (_cliDetector is ClaudeCliDetector detector)
        {
            detector.ClearCache();
        }

        _isCliInstalled = await _cliDetector!.IsInstalledAsync();

        if (!_isCliInstalled.Value)
        {
            _installInstructions = _cliDetector.GetInstallationInstructions();
        }

        StateHasChanged();
    }

    private async Task SendMessage(string message)
    {
        if (_cliService == null) return;

        // Add user message
        _currentConversation.Messages.Add(new ChatMessage
        {
            Role = MessageRole.User,
            Content = message
        });

        // Start streaming response
        _isStreaming = true;
        _streamingContent = string.Empty;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            await foreach (var chunk in _cliService.SendMessageAsync(message))
            {
                _streamingContent += chunk;
                StateHasChanged();
            }

            // Add completed assistant message
            _currentConversation.Messages.Add(new ChatMessage
            {
                Role = MessageRole.Assistant,
                Content = _streamingContent
            });

            _currentConversation.UpdatedAt = DateTime.UtcNow;
        }
        catch (OperationCanceledException)
        {
            // User cancelled - add partial response if any
            if (!string.IsNullOrEmpty(_streamingContent))
            {
                _currentConversation.Messages.Add(new ChatMessage
                {
                    Role = MessageRole.Assistant,
                    Content = _streamingContent + "\n\n*[Response cancelled]*"
                });
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error sending message to Claude CLI");
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isStreaming = false;
            _streamingContent = string.Empty;
            StateHasChanged();
        }
    }

    private void CancelRequest()
    {
        _cliService?.CancelCurrentRequest();
    }
}
